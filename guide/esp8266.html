<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ESP8266 Device | DHAP</title>
    <meta name="description" content="Decentralised Home Automation Protocol Documentation">
    
    
    <link rel="preload" href="/DHAP-Documentation/assets/css/0.styles.5604310b.css" as="style"><link rel="preload" href="/DHAP-Documentation/assets/js/app.ee0d968a.js" as="script"><link rel="preload" href="/DHAP-Documentation/assets/js/2.c97535ac.js" as="script"><link rel="preload" href="/DHAP-Documentation/assets/js/11.3c9e5aad.js" as="script"><link rel="prefetch" href="/DHAP-Documentation/assets/js/10.b1db677c.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/12.834af0f2.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/13.54851ada.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/14.645edb52.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/15.e3f71b71.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/16.996da96d.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/17.6d0813f1.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/3.a35a8884.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/4.3d1a62e5.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/5.5d5e6d2b.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/6.5d05364a.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/7.fb09b9af.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/8.2fb19c78.js"><link rel="prefetch" href="/DHAP-Documentation/assets/js/9.cf65704a.js">
    <link rel="stylesheet" href="/DHAP-Documentation/assets/css/0.styles.5604310b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/DHAP-Documentation/" class="home-link router-link-active"><!----> <span class="site-name">DHAP</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Home</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DHAP-Documentation/" class="sidebar-link">Introduction</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DHAP-Documentation/guide/" class="sidebar-link">Quick Library Installation</a></li><li><a href="/DHAP-Documentation/guide/android.html" class="sidebar-link">Android Library</a></li><li><a href="/DHAP-Documentation/guide/ios.html" class="sidebar-link">iOS Library</a></li><li><a href="/DHAP-Documentation/guide/desktop.html" class="sidebar-link">Desktop Application</a></li><li><a href="/DHAP-Documentation/guide/esp8266.html" class="active sidebar-link">ESP8266 Device</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DHAP-Documentation/guide/esp8266.html#installation" class="sidebar-link">Installation</a></li><li class="sidebar-sub-header"><a href="/DHAP-Documentation/guide/esp8266.html#usage" class="sidebar-link">Usage</a></li><li class="sidebar-sub-header"><a href="/DHAP-Documentation/guide/esp8266.html#devicestatus-class" class="sidebar-link">DeviceStatus class</a></li><li class="sidebar-sub-header"><a href="/DHAP-Documentation/guide/esp8266.html#arduino-setup-and-loop" class="sidebar-link">Arduino setup() and loop()</a></li><li class="sidebar-sub-header"><a href="/DHAP-Documentation/guide/esp8266.html#xml-file-upload" class="sidebar-link">XML file upload</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DHAP-Documentation/api/" class="sidebar-link">Android API</a></li><li><a href="/DHAP-Documentation/api/ios.html" class="sidebar-link">iOS API</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Reference</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DHAP-Documentation/reference/packet-types.html" class="sidebar-link">Packet Types</a></li><li><a href="/DHAP-Documentation/reference/elements.html" class="sidebar-link">Elements</a></li><li><a href="/DHAP-Documentation/reference/xml-schema.html" class="sidebar-link">XML Schema</a></li><li><a href="/DHAP-Documentation/reference/device-examples.html" class="sidebar-link">Device Examples</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="esp8266-device"><a href="#esp8266-device" aria-hidden="true" class="header-anchor">#</a> ESP8266 Device</h1> <p>An Arduino project for use with an ESP8266 device has been developed to act as an IoT device in a network. This project handles all of the protocols for you such as joining and discovery. The project only requires you to implement a few methods which determine the current status of a device as this will be unique to each product.</p> <h2 id="installation"><a href="#installation" aria-hidden="true" class="header-anchor">#</a> Installation</h2> <p>To begin, clone the repo for the <a href="https://github.com/decentralised-home-automation-protocol/DHAP-ESP8266" target="_blank" rel="noopener noreferrer">ESP8266 project<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <ul><li><p>Download and install the <a href="https://www.arduino.cc/en/main/software" target="_blank" rel="noopener noreferrer">Arduino IDE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></li> <li><p>Download and install the <a href="https://github.com/esp8266/arduino-esp8266fs-plugin" target="_blank" rel="noopener noreferrer">Arduino ESP8266 filesystem uploader plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for the Arduino IDE. This plugin is required to upload the device xml file onto the ESP8266 device. The xml must be stored in the file <code>app/data/layout.xml</code>.</p></li> <li><p>Clone the repo and open it in the Arduino IDE. The only file that you should need to edit is <code>app.ino</code>.</p></li></ul> <h2 id="usage"><a href="#usage" aria-hidden="true" class="header-anchor">#</a> Usage</h2> <p>The project requires you to implement the provided functions found in the <code>DeviceStatus</code> class. This class can be found in the main file <code>app.ino</code> and should be the only place where you will need to add your device specific code. This class will handle the state of your IoT device and will therefore be unique to each device. As an overview, the Status class contains several methods that must be overridden <code>getStatus()</code>, <code>executeCommand(String elementID, String data)</code>, <code>getMaxLeaseLength()</code> and <code>getMinUpdatePeriod()</code>. All other functionality of the IoT device and DHAP protocol will be handled for you.</p> <p>The implementation of these methods is up to you as it will depend on the functionality of your IoT device. For more information on how to structure status updates as well as the structure of IoT commands, see <a href="https://decentralised-home-automation-protocol.github.io/DHAP-Documentation/reference/packet-types.html#status-update" target="_blank" rel="noopener noreferrer">the status update packet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://decentralised-home-automation-protocol.github.io/DHAP-Documentation/reference/packet-types.html#command-request" target="_blank" rel="noopener noreferrer">the command packet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This documentation describes the structure of the various network packets sent to and from you IoT device.</p> <p>The user interface for your device is defined using the <a href="https://decentralised-home-automation-protocol.github.io/DHAP-Documentation/reference/xml-schema.html" target="_blank" rel="noopener noreferrer">DHAP xml schema<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This will be uploaded onto the ESP using <a href="https://github.com/esp8266/arduino-esp8266fs-plugin" target="_blank" rel="noopener noreferrer">Arduino ESP8266 filesystem uploader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> plugin and must be stored in the file found at <code>app/data/layout.xml</code></p> <h2 id="devicestatus-class"><a href="#devicestatus-class" aria-hidden="true" class="header-anchor">#</a> DeviceStatus class</h2> <p>As this device is responsible for handling the state of your device, it will typically include several local variables and data structures to store an alter the devices state. For example, if the user interface of your device includes a <a href="https://decentralised-home-automation-protocol.github.io/DHAP-Documentation/reference/elements.html#stepper" target="_blank" rel="noopener noreferrer">stepper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> element, this would require a local <code>int</code> variable to increment and decrement the value when a new command is received.</p> <p>The <a href="https://github.com/decentralised-home-automation-protocol/DHAP-ESP8266" target="_blank" rel="noopener noreferrer">ESP8266 Repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> contains several example devices in various branches. These devices can be used as a guide when developing your own device.</p> <h3 id="getstatus"><a href="#getstatus" aria-hidden="true" class="header-anchor">#</a> getStatus()</h3> <p>This method will be called each time the device sends a status update. The status update packet is formatted with the following syntax:</p> <p><code>packetType|mac,lastUpdate,elementState,elementState,elementState...</code></p> <p>The <code>packetType</code>, <code>mac</code> and <code>lastupdate</code> fields will be added for you in a status update. Therefore, your <code>getStatus()</code> method only needs to return the state of each UI element as a string of comma separated values. <a href="https://decentralised-home-automation-protocol.github.io/DHAP-Documentation/reference/packet-types.html#status-update" target="_blank" rel="noopener noreferrer">The status update packet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> page has information on how these values should be structured while the <a href="https://decentralised-home-automation-protocol.github.io/DHAP-Documentation/reference/elements.html#switch-toggle" target="_blank" rel="noopener noreferrer">elements documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> specifies the state string of each element.</p> <p>These comma separated values must be placed in the same order as the <code>&lt;status_location&gt;</code> tags specify in the devices xml. For example, for the following xml:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">permisison</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>WR<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>gui_element</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>switchtoggle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disp_settings</span><span class="token punctuation">&gt;</span></span>On/Off<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disp_settings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>status_location</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>status_location</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>Light Switch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>gui_element</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">permisison</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>WR<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>gui_element</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>rangeinput<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disp_settings</span><span class="token punctuation">&gt;</span></span>Volume,Set,0,150<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disp_settings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>status_location</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>status_location</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>Volume Slider<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>gui_element</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>gui_element</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>selection<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disp_settings</span><span class="token punctuation">&gt;</span></span>Day of week,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disp_settings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>status_location</span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>status_location</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>Door positions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>gui_element</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>The initial state of the device might have the <code>switchtoggle</code> as false, the <code>rangeinput</code> with a value of 20 and the selection currently on option <code>3</code> (Thursday)</p> <p>Therefore, if <code>getStatus()</code> is called while the device is in this state. It should return <code>false,20,3</code>.</p> <h3 id="executecommand-string-elementid-string-data"><a href="#executecommand-string-elementid-string-data" aria-hidden="true" class="header-anchor">#</a> executeCommand(String elementID, String data)</h3> <p>This function will be called each time a new IoT command is received from a control device. The two parameters relate to the <code>Id</code> of the UI element that the user interacted with on the control device and the new state of that element. The structure of the IoT commands can be seen in the <a href="https://decentralised-home-automation-protocol.github.io/DHAP-Documentation/reference/packet-types.html#command-request" target="_blank" rel="noopener noreferrer">Command Request packet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>From out previous example, if the <code>selection</code> element was changed from the option Thursday to Saturday, this function would be called with the parameters <code>2-2</code> and <code>5</code>. This is because the <code>Id</code> of the <code>selection</code> element is <code>2-2</code> (groupID-elementID) and the index of the value Saturday is <code>5</code>.</p> <p>After this command is received, the local variable representing the state of the <code>selection</code> element should be changed to <code>5</code> so that the next time <code>getStatus()</code> is called, the value <code>5</code> will be used as the new state of the <code>selection</code> element.</p> <h3 id="getmaxleaselength"><a href="#getmaxleaselength" aria-hidden="true" class="header-anchor">#</a> getMaxLeaseLength()</h3> <p>This function should simply return the maximum lease length allowed by this device. Status updates in the DHAP protocol work off of leases of a limited duration. This method will be called when a control device requests a new lease. The value returned by this function will be used to cap how long a lease can exist for. This function should return a time in milliseconds.</p> <h3 id="getminupdateperiod"><a href="#getminupdateperiod" aria-hidden="true" class="header-anchor">#</a> getMinUpdatePeriod()</h3> <p>This function should simply return the minimum update period that the device will broadcast its current status. This function should return a time in milliseconds.</p> <p>For example if this function returns the value <code>500</code> and a control device requests a status update lease with updates every 100ms. The lease will be granted but status updates will only be broadcast at a rate of 1 update every 500ms.</p> <h2 id="arduino-setup-and-loop"><a href="#arduino-setup-and-loop" aria-hidden="true" class="header-anchor">#</a> Arduino setup() and loop()</h2> <p>For a typical usage of this project, you should not need to alter the code in these methods. The standard usage of these functions only requires an instance of the <code>IoTDevice</code> class and the user defined <code>DeviceStatus</code> class. The <code>IoTDevice</code> class will handle all of the functions of the DHAP protocol such as joining, discovery and status updates. This class will simply use your user defined class when it calls the methods described above.</p> <p>The <code>IoTDevice</code> class needs to be called in the <code>setup()</code> function to initialize the ESP into Access Point (AP) mode or to join a previously saved AP. The <code>ioTDevice.setup(false, deviceStatus)</code> takes two parameters which are a reference to the <code>DeviceStatus</code> instance and a boolean that forces the device into AP mode. If this is set to <code>true</code>, the device will enter AP mode on startup. If this is set to <code>false</code>, the device will attempt to join the last known network that it was joined to, If this fails the device will enter AP mode.</p> <p>While in AP mode the device can be connected to from a control device and the joining procedure can be performed.</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code>IoTDevice ioTDevice<span class="token punctuation">;</span>
DeviceStatus deviceStatus<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  ioTDevice<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span>deviceStatus<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ioTDevice<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="xml-file-upload"><a href="#xml-file-upload" aria-hidden="true" class="header-anchor">#</a> XML file upload</h2> <p>Remember to upload the devices layout xml using the file system uploader plugin into a file named <code>layout.xml</code> onto the esp8266. This file is already included in the repo with an example device present. Instructions on how to upload a file to the ESP is found of the <a href="https://github.com/esp8266/arduino-esp8266fs-plugin" target="_blank" rel="noopener noreferrer">Arduino ESP8266 filesystem uploader plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> repo. It is also recommended to run any xml you have developed through an <a href="https://www.webtoolkitonline.com/xml-minifier.html" target="_blank" rel="noopener noreferrer">xml minifier<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to reduce the size of the file. It should be noted that when a new XML file is uploaded to the ESP, any current header or network credentials saved will be cleared. Therefore, the device will need to be rejoined to a network using the joining protocol.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/DHAP-Documentation/guide/desktop.html" class="prev">
          Desktop Application
        </a></span> <span class="next"><a href="/DHAP-Documentation/api/">
          Android API
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/DHAP-Documentation/assets/js/app.ee0d968a.js" defer></script><script src="/DHAP-Documentation/assets/js/2.c97535ac.js" defer></script><script src="/DHAP-Documentation/assets/js/11.3c9e5aad.js" defer></script>
  </body>
</html>
